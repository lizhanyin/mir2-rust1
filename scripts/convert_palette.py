#!/usr/bin/env python3
"""调色板转换工具 - 将Java/C#格式转换为Rust格式"""

# Java/C#格式的调色板数据 (ARGB格式的有符号整数)
PALETTE_DATA = [
    0, -8388608, -16744448, -8355840, -16777088, -8388480, -16744320, -4144960, -11173737, -6440504, -8686733, -13817559, -10857902, -10266022, -12437191, -14870504, -15200240, -14084072, -15726584, -886415, -2005153, -42406, -52943, -2729390, -7073792, -7067368, -13039616, -9236480, -4909056, -4365486, -12445680, -21863, -10874880, -9225943, -5944783, -7046285, -4369871, -11394800, -8703720, -13821936, -7583183, -7067392, -4378368, -3771566, -9752296, -3773630, -3257856, -5938375, -10866408, -14020608, -15398912, -12969984, -16252928, -14090240, -11927552, -6488064, -2359296, -2228224, -327680, -6524078, -7050422, -9221591, -11390696, -7583208, -7846895, -11919104, -14608368, -2714534, -3773663, -1086720, -35072, -5925756, -12439263, -15200248, -14084088, -14610432, -13031144, -7576775, -12441328, -9747944, -8697320, -7058944, -7568261, -9739430, -11910599, -14081768, -12175063, -4872812, -8688806, -3231340, -5927821, -7572646, -4877197, -2710157, -1071798, -1063284, -8690878, -9742791, -4352934, -10274560, -2701651, -11386327, -7052520, -1059155, -5927837, -10266038, -4348549, -10862056, -4355023, -13291223, -7043997, -8688822, -5927846, -10859991, -6522055, -12439280, -1069791, -15200256, -14081792, -6526208, -7044006, -11386344, -9741783, -8690911, -6522079, -2185984, -10857927, -13555440, -3228293, -10266055, -7044022, -3758807, -15688680, -12415926, -13530046, -15690711, -16246768, -16246760, -16242416, -15187415, -5917267, -9735309, -15193815, -15187382, -13548982, -10238242, -12263937, -7547153, -9213127, -532935, -528500, -530688, -9737382, -10842971, -12995089, -11887410, -13531979, -13544853, -2171178, -4342347, -7566204, -526370, -16775144, -16246727, -16248791, -16246784, -16242432, -16756059, -16745506, -15718070, -15713941, -15707508, -14591323, -15716006, -15711612, -13544828, -15195855, -11904389, -11375707, -14075549, -15709474, -14079711, -11908551, -14079720, -11908567, -8684734, -6513590, -10855895, -12434924, -13027072, -10921728, -3525332, -9735391, -14077696, -13551344, -13551336, -12432896, -11377896, -10849495, -13546984, -15195904, -15191808, -15189744, -10255286, -9716406, -10242742, -10240694, -10838966, -11891655, -10238390, -10234294, -11369398, -13536471, -10238374, -11354806, -15663360, -15193832, -11892662, -11868342, -16754176, -16742400, -16739328, -16720384, -16716288, -16712960, -11904364, -10259531, -8680234, -9733162, -8943361, -3750194, -7039844, -6515514, -13553351, -14083964, -15204220, -11910574, -11386245, -10265997, -3230217, -7570532, -8969524, -2249985, -1002454, -2162529, -1894477, -1040, -6250332, -8355712, -65536, -16711936, -256, -16776961, -65281, -16711681, -1
]

def int_to_rgba(value: int) -> tuple:
    """将Java/C#的ARGB int转换为RGBA元组

    Java/C#中颜色以ARGB格式存储为32位有符号整数
    负数表示alpha=255，正数表示alpha=0
    """
    # 转换为无符号32位整数
    if value < 0:
        value = value + 2**32

    # 提取ARGB分量
    a = (value >> 24) & 0xFF
    r = (value >> 16) & 0xFF
    g = (value >> 8) & 0xFF
    b = value & 0xFF

    return (a, r, g, b)


def generate_rust_palette() -> str:
    """生成Rust格式的调色板代码"""
    lines = []
    lines.append("/// 传奇2默认调色板")
    lines.append("pub const DEFAULT_PALETTE: [Color; 256] = [")

    for i, value in enumerate(PALETTE_DATA):
        a, r, g, b = int_to_rgba(value)
        lines.append(f"    Color {{ a: {a}, r: {r}, g: {g}, b: {b} }}, // index {i}: 0x{value:08X}")

    lines.append("];")
    return "\n".join(lines)


def generate_palette_lookup() -> str:
    """生成调色板查找表代码"""
    lines = []
    lines.append("/// 快速查找表 (u32格式的颜色值)")
    lines.append("pub const PALETTE_U32: [u32; 256] = [")

    row_values = []
    for i, value in enumerate(PALETTE_DATA):
        # 转换为u32格式 (ABGR for little-endian)
        a, r, g, b = int_to_rgba(value)
        u32_value = (a << 24) | (b << 16) | (g << 8) | r
        row_values.append(f"0x{u32_value:08X}")

        # 每16个值换行
        if (i + 1) % 16 == 0:
            lines.append("    " + ", ".join(row_values) + ",")
            row_values = []

    if row_values:  # 处理剩余的值
        lines.append("    " + ", ".join(row_values) + ",")

    lines.append("];")
    return "\n".join(lines)


if __name__ == "__main__":
    print("=" * 60)
    print("调色板转换工具")
    print("=" * 60)
    print(f"总共 {len(PALETTE_DATA)} 个颜色")
    print()

    # 显示一些示例转换
    print("示例颜色转换:")
    for i in [0, 1, 2, 255]:
        a, r, g, b = int_to_rgba(PALETTE_DATA[i])
        print(f"  Index {i:3d}: {PALETTE_DATA[i]:12d} -> A={a:3d} R={r:3d} G={g:3d} B={b:3d}")
    print()

    # 生成Rust代码
    print("生成Rust代码到 palette_converted.rs ...")
    rust_code = f'''//! 自动生成的调色板数据
//! 由 scripts/convert_palette.py 生成

{generate_rust_palette()}

{generate_palette_lookup()}
'''

    with open("src/image/palette_data.rs", "w", encoding="utf-8") as f:
        f.write(rust_code)

    print("完成!")
    print()
    print("统计信息:")
    # 统计透明颜色数量
    transparent_count = sum(1 for v in PALETTE_DATA if int_to_rgba(v)[0] == 0)
    opaque_count = len(PALETTE_DATA) - transparent_count
    print(f"  不透明颜色: {opaque_count}")
    print(f"  透明颜色: {transparent_count}")
