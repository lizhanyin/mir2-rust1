// Library Editor 主窗口
// 新布局：顶部菜单栏 + 中间左右分栏 + 底部缩略图
// 使用模块化组件

import { Toolbar } from "components/toolbar.slint";
import { PropertyPanel } from "components/property_panel.slint";
import { PreviewPanel } from "components/preview_panel.slint";
import { ThumbnailGrid } from "components/thumbnail_grid.slint";
import { StatusBar } from "components/status_bar.slint";

export component AppWindow inherits Window {
    title: "Library Editor - Rust";
    width: 1024px;
    height: 768px;
    resize-border-width: 8px;

    // 将焦点转发给 FocusScope
    forward-focus: focus-scope;

    // 状态属性
    in-out property <string> status_text: "就绪";
    in-out property <string> file_name: "";
    in-out property <int> image_count: 0;
    in-out property <int> current_index: -1;

    // 图像信息
    in-out property <int> image_width: 0;
    in-out property <int> image_height: 0;
    in-out property <string> image_format: "-";
    in-out property <int> image_x: 0;
    in-out property <int> image_y: 0;

    // 缩略图数组（用于存储所有图像的缩略图数据）
    in-out property <[image]> thumbnails: [];

    // 主预览图（当前选中图像的大尺寸预览）
    in-out property <image> main_preview;

    // 主预览区背景色 (true=白色, false=黑色)
    in-out property <bool> preview_bg_light: false;

    // 缩放比例 (50-200, 默认100表示100%)
    in-out property <int> zoom_scale: 100;

    // 加载进度 (0-100)
    in-out property <int> load_progress: 0;
    // 是否正在加载
    in-out property <bool> is_loading: false;
    // 已加载数量
    in-out property <int> loaded_count: 0;

    // 回调
    callback open_file();
    callback save_file();
    callback save_as_file();
    callback export_png();
    callback replace_image();
    callback prev_image();
    callback next_image();
    callback thumbnail_clicked(int);
    callback toggle_preview_bg();
    callback key_pressed(string);

    // 主容器 - 使用 FocusScope 处理键盘事件
    focus-scope := FocusScope {
        width: 100%;
        height: 100%;

        key-pressed(event) => {
            // 调用 Rust 回调记录日志
            root.key_pressed(event.text);

            if root.image_count == 0 {
                return reject;
            }

            let current = root.current_index;

            if event.text == Key.LeftArrow {
                if current > 0 {
                    root.current_index = current - 1;
                    root.thumbnail_clicked(root.current_index);
                }
                return accept;
            } else if event.text == Key.RightArrow {
                if current < root.image_count - 1 {
                    root.current_index = current + 1;
                    root.thumbnail_clicked(root.current_index);
                }
                return accept;
            } else if event.text == Key.Home {
                root.current_index = 0;
                root.thumbnail_clicked(0);
                return accept;
            } else if event.text == Key.End {
                root.current_index = root.image_count - 1;
                root.thumbnail_clicked(root.image_count - 1);
                return accept;
            }

            return reject;
        }

        Rectangle {
            background: #1e1e1e;

        VerticalLayout {
            spacing: 0px;

            // ========== 顶部菜单栏 ==========
            Toolbar {
                preview_bg_light: root.preview_bg_light;
                zoom_scale <=> root.zoom_scale;
                open_file => { root.open_file(); }
                save_file => { root.save_file(); }
                save_as_file => { root.save_as_file(); }
                export_png => { root.export_png(); }
                replace_image => { root.replace_image(); }
                prev_image => { root.prev_image(); }
                next_image => { root.next_image(); }
                toggle_preview_bg => { root.toggle_preview_bg(); }
            }

            // ========== 中间区域：左右分栏 ==========
            Rectangle {
                background: #1e1e1e;
                min-height: 400px;

                HorizontalLayout {
                    spacing: 0px;

                    // ========== 左侧：属性操作面板 ==========
                    PropertyPanel {
                        file_name: root.file_name;
                        image_count: root.image_count;
                        current_index: root.current_index;
                        image_x: root.image_x;
                        image_y: root.image_y;
                        image_width: root.image_width;
                        image_height: root.image_height;
                    }

                    // ========== 右侧：主预览区域 ==========
                    PreviewPanel {
                        current_index: root.current_index;
                        main_preview: root.main_preview;
                        preview_bg_light: root.preview_bg_light;
                        zoom_scale: root.zoom_scale;
                    }
                }
            }

            // ========== 底部：缩略图列表 ==========
            ThumbnailGrid {
                image_count: root.image_count;
                current_index: root.current_index;
                thumbnails: root.thumbnails;
                thumbnail_clicked(index) => { root.thumbnail_clicked(index); }
            }

            // ========== 底部状态栏 ==========
            StatusBar {
                status_text: root.status_text;
                load_progress: root.load_progress;
                is_loading: root.is_loading;
                loaded_count: root.loaded_count;
                image_count: root.image_count;
            }
        }
    }
    }
}
