// Library Editor ä¸»çª—å£
// æ–°å¸ƒå±€ï¼šé¡¶éƒ¨èœå•æ  + ä¸­é—´å·¦å³åˆ†æ  + åº•éƒ¨ç¼©ç•¥å›¾

// ========== å·¥å…·æ æŒ‰é’®ç»„ä»¶ ==========
component ToolbarButton inherits Rectangle {
    // å…¬å…±å±æ€§
    in-out property <string> icon: "";
    in-out property <string> text: "";
    in-out property <string> tooltip-text: "";
    callback clicked_handler();

    // æ ¹æ®æ˜¯å¦æœ‰å›¾æ ‡å†³å®šå°ºå¯¸
    width: self.icon == "" ? 60px : 32px;
    height: 28px;
    background: touch.has-hover ? #3e3e42 : #2d2d2d;
    border-radius: 4px;

    // è§¦æ‘¸åŒºåŸŸå¤„ç†æ‚¬åœå’Œç‚¹å‡»
    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked_handler(); }

        // å·¥å…·æç¤ºï¼ˆä»…åœ¨æ‚¬åœæ—¶æ˜¾ç¤ºï¼‰
        if self.has-hover && root.tooltip-text != "" : Rectangle {
            x: -10px;
            y: 32px;
            width: 100px;
            height: 22px;
            background: #252526;
            border-width: 1px;
            border-color: #007acc;
            border-radius: 3px;

            Text {
                text: root.tooltip-text;
                color: #ffffff;
                font-size: 11px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }

    // æŒ‰é’®å†…å®¹
    HorizontalLayout {
        spacing: 4px;
        alignment: center;

        // å›¾æ ‡ï¼ˆå¦‚æœæœ‰ï¼‰
        if root.icon != "" : Text {
            text: root.icon;
            color: #cccccc;
            font-size: 15px;
            vertical-alignment: center;
        }

        // æ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
        if root.text != "" : Text {
            text: root.text;
            color: #cccccc;
            font-size: 13px;
            vertical-alignment: center;
        }
    }
}

// ========== ä¸»çª—å£ç»„ä»¶ ==========
export component AppWindow inherits Window {
    title: "Library Editor - Rust";
    width: 1200px;
    height: 800px;

    // çŠ¶æ€å±æ€§
    in-out property <string> status_text: "å°±ç»ª";
    in-out property <string> file_name: "";
    in-out property <int> image_count: 0;
    in-out property <int> current_index: -1;

    // å›¾åƒä¿¡æ¯
    in-out property <int> image_width: 0;
    in-out property <int> image_height: 0;
    in-out property <string> image_format: "-";
    in-out property <int> image_x: 0;
    in-out property <int> image_y: 0;

    // ç¼©ç•¥å›¾æ•°ç»„ï¼ˆç”¨äºå­˜å‚¨æ‰€æœ‰å›¾åƒçš„ç¼©ç•¥å›¾æ•°æ®ï¼‰
    in-out property <[image]> thumbnails: [];

    // ä¸»é¢„è§ˆå›¾ï¼ˆå½“å‰é€‰ä¸­å›¾åƒçš„å¤§å°ºå¯¸é¢„è§ˆï¼‰
    in-out property <image> main_preview;

    // ä¸»é¢„è§ˆåŒºèƒŒæ™¯è‰² (true=ç™½è‰², false=é»‘è‰²)
    in-out property <bool> preview_bg_light: false;

    // å›è°ƒ
    callback open_file();
    callback save_file();
    callback save_as_file();
    callback export_png();
    callback replace_image();
    callback prev_image();
    callback next_image();
    callback thumbnail_clicked(int);
    callback toggle_preview_bg();

    @children
    // ä¸»å®¹å™¨
    Rectangle {
        background: #1e1e1e;

        VerticalLayout {
            spacing: 0px;

            // ========== é¡¶éƒ¨èœå•æ  ==========
            Rectangle {
                background: #2d2d2d;
                height: 32px;
                
                HorizontalLayout {
                    padding-left: 8px;
                    padding-top: 4px;
                    padding-right: 8px;
                    spacing: 4px;

                    // å·¥å…·æ æŒ‰é’®ç»„
                    ToolbarButton {
                        icon: "ğŸ“‚";
                        tooltip-text: "æ‰“å¼€æ–‡ä»¶";
                        clicked_handler => { root.open_file(); }
                    }

                    ToolbarButton {
                        icon: "ğŸ’¾";
                        tooltip-text: "ä¿å­˜æ–‡ä»¶";
                        clicked_handler => { root.save_file(); }
                    }

                    ToolbarButton {
                        icon: "ğŸ’¡";
                        tooltip-text: "å¦å­˜ä¸º";
                        clicked_handler => { root.save_as_file(); }
                    }

                    ToolbarButton {
                        icon: "ğŸ“¤";
                        tooltip-text: "å¯¼å‡ºPNG";
                        clicked_handler => { root.export_png(); }
                    }

                    ToolbarButton {
                        icon: "ğŸ”„";
                        tooltip-text: "æ›¿æ¢å›¾åƒ";
                        clicked_handler => { root.replace_image(); }
                    }

                    ToolbarButton {
                        icon: "â—€";
                        tooltip-text: "ä¸Šä¸€å¼ å›¾åƒ";
                        clicked_handler => { root.prev_image(); }
                    }

                    ToolbarButton {
                        icon: "â–¶";
                        tooltip-text: "ä¸‹ä¸€å¼ å›¾åƒ";
                        clicked_handler => { root.next_image(); }
                    }

                    // åˆ‡æ¢èƒŒæ™¯è‰²æŒ‰é’®
                    ToolbarButton {
                        icon: root.preview_bg_light ? "â¬›" : "â¬œ";
                        tooltip-text: root.preview_bg_light ? "åˆ‡æ¢åˆ°é»‘è‰²èƒŒæ™¯" : "åˆ‡æ¢åˆ°ç™½è‰²èƒŒæ™¯";
                        clicked_handler => { root.toggle_preview_bg(); }
                    }

                    // å³ä¾§å¼¹æ€§ç©ºé—´
                    Rectangle {}

                    // åˆ†éš”çº¿
                    Rectangle {
                        width: 1px;
                        background: #3e3e42;
                    }
                }
            }

            // ========== ä¸­é—´åŒºåŸŸï¼šå·¦å³åˆ†æ  ==========
            Rectangle {
                background: #1e1e1e;
                min-height: 400px;

                HorizontalLayout {
                    spacing: 0px;

                    // ========== å·¦ä¾§ï¼šå±æ€§æ“ä½œé¢æ¿ ==========
                    Rectangle {
                        background: #252526;
                        width: 280px;

                        VerticalLayout {
                            spacing: 0px;

                            // å†…å®¹åŒºåŸŸ
                            Rectangle {
                                VerticalLayout {
                                    padding: 16px;
                                    spacing: 16px;

                                    // === æ–‡ä»¶ä¿¡æ¯ç»„ ===
                                    VerticalLayout {
                                        spacing: 8px;

                                        Text {
                                            text: "æ–‡ä»¶ä¿¡æ¯";
                                            color: #858585;
                                            font-size: 11px;
                                            font-weight: 600;
                                        }

                                        VerticalLayout {
                                            spacing: 6px;
                                            padding-left: 8px;

                                            HorizontalLayout {
                                                spacing: 8px;

                                                Text {
                                                    text: "æ–‡ä»¶å:";
                                                    color: #858585;
                                                    font-size: 12px;
                                                    width: 50px;
                                                }

                                                Text {
                                                    text: root.file_name == "" ? "æœªåŠ è½½" : root.file_name;
                                                    color: #cccccc;
                                                    font-size: 12px;
                                                    overflow: elide;
                                                }
                                            }

                                            Text {
                                                text: "å›¾åƒæ€»æ•°: " + root.image_count;
                                                color: #cccccc;
                                                font-size: 12px;
                                            }
                                        }
                                    }

                                    // åˆ†éš”çº¿
                                    Rectangle {
                                        height: 1px;
                                        background: #3e3e42;
                                    }

                                    VerticalLayout {
                                        spacing: 8px;

                                        Text {
                                            text: "å½“å‰å›¾åƒ";
                                            color: #858585;
                                            font-size: 11px;
                                            font-weight: 600;
                                        }

                                        VerticalLayout {
                                            spacing: 6px;
                                            padding-left: 8px;

                                            HorizontalLayout {
                                                spacing: 8px;

                                                Text {
                                                    text: "ç´¢å¼•:";
                                                    color: #858585;
                                                    font-size: 12px;
                                                    width: 50px;
                                                }

                                                Text {
                                                    text: root.current_index >= 0 ? root.current_index : "-";
                                                    color: #cccccc;
                                                    font-size: 12px;
                                                }

                                                Text {
                                                    text: "X:";
                                                    color: #858585;
                                                    font-size: 12px;
                                                    width: 50px;
                                                }

                                                Text {
                                                    text: "Y:";
                                                    color: #858585;
                                                    font-size: 12px;
                                                    width: 50px;
                                                }
                                            }

                                            HorizontalLayout {
                                                spacing: 8px;

                                                Text {
                                                    text: "å®½åº¦:";
                                                    color: #858585;
                                                    font-size: 12px;
                                                    width: 50px;
                                                }

                                                Text {
                                                    text: root.current_index >= 0 ? root.image_width : "-";
                                                    color: #cccccc;
                                                    font-size: 12px;
                                                }

                                                HorizontalLayout {
                                                    spacing: 8px;

                                                    Text {
                                                        text: "é«˜åº¦:";
                                                        color: #858585;
                                                        font-size: 12px;
                                                        width: 50px;
                                                    }

                                                    Text {
                                                        text: root.current_index >= 0 ? root.image_height : "-";
                                                        color: #cccccc;
                                                        font-size: 12px;
                                                    }
                                                }
                                            }
                                        }
                                    }

                                    // åˆ†éš”çº¿
                                    Rectangle {
                                        height: 1px;
                                        background: #3e3e42;
                                    }

                                    // === è°ƒè‰²æ¿ä¿¡æ¯ ===
                                    VerticalLayout {
                                        spacing: 8px;

                                        Text {
                                            text: "è°ƒè‰²æ¿";
                                            color: #858585;
                                            font-size: 11px;
                                            font-weight: 600;
                                        }

                                        VerticalLayout {
                                            spacing: 6px;
                                            padding-left: 8px;

                                            Text {
                                                text: "256 è‰²";
                                                color: #cccccc;
                                                font-size: 12px;
                                            }

                                            Text {
                                                text: "ARGB 8888";
                                                color: #cccccc;
                                                font-size: 12px;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // ========== å³ä¾§ï¼šä¸»é¢„è§ˆåŒºåŸŸ ==========
                    Rectangle {
                        background: root.preview_bg_light ? #ffffff : #1a1a1a;

                        VerticalLayout {
                            spacing: 0px;

                            // é¢„è§ˆç”»å¸ƒ
                            Rectangle {
                                HorizontalLayout {
                                    alignment: center;

                                    Rectangle {
                                        width: 400px;
                                        height: 400px;

                                        // æ˜¾ç¤ºå›¾åƒæˆ–å ä½ç¬¦
                                        if root.current_index >= 0 : Rectangle {
                                            background: root.preview_bg_light ? #ffffff : #1a1a1a;

                                            // æ˜¾ç¤ºå®é™…å›¾åƒé¢„è§ˆ
                                            if root.main_preview.width > 0 : Image {
                                                source: root.main_preview;
                                                width: 380px;
                                                height: 380px;
                                                image-fit: contain;
                                            }

                                            // æ— é¢„è§ˆå›¾æ—¶æ˜¾ç¤ºå ä½ç¬¦
                                            if root.main_preview.width == 0 : Text {
                                                text: "é¢„è§ˆåŒºåŸŸ\n" + "å›¾åƒ " + root.current_index;
                                                color: root.preview_bg_light ? #666 : #cccccc;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                                font-size: 16px;
                                            }
                                        }

                                        if root.current_index < 0 : Rectangle {
                                            background: #1e1e1e;

                                            Text {
                                                text: "è¯·é€‰æ‹©ä¸€å¼ å›¾åƒ";
                                                color: #666;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                                font-size: 14px;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // ========== åº•éƒ¨ï¼šç¼©ç•¥å›¾åˆ—è¡¨ ==========
            Rectangle {
                background: #252526;
                height: 140px;

                VerticalLayout {
                    spacing: 0px;

                    // ç¼©ç•¥å›¾æ ‡é¢˜æ 
                    Rectangle {
                        background: #2d2d2d;
                        height: 28px;

                        HorizontalLayout {
                            padding-left: 12px;
                            padding-right: 12px;
                            padding-top: 8px;
                            padding-bottom: 8px;

                            Text {
                                text: "ç¼©ç•¥å›¾";
                                color: #cccccc;
                                font-size: 12px;
                                font-weight: 600;
                                vertical-alignment: center;
                            }

                            Rectangle {}

                            Text {
                                text: root.image_count + " å¼ å›¾åƒ";
                                color: #858585;
                                font-size: 11px;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // ç¼©ç•¥å›¾æ»šåŠ¨åŒºåŸŸ
                    Rectangle {
                        background: #1e1e1e;

                        HorizontalLayout {
                            padding: 8px;
                            spacing: 4px;
                            alignment: center;

                            // ç¼©ç•¥å›¾åˆ—è¡¨
                            for i in root.image_count : Rectangle {
                                width: 80px;
                                height: 80px;
                                background: i == root.current_index ? #37373d : #2d2d2d;
                                border-width: i == root.current_index ? 2px : 1px;
                                border-color: i == root.current_index ? #007acc : #3e3e42;
                                border-radius: 4px;

                                TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.thumbnail_clicked(i); }
                                }

                                VerticalLayout {
                                    spacing: 4px;
                                    padding: 4px;

                                    // ç¼©ç•¥å›¾é¢„è§ˆ - æ˜¾ç¤ºå®é™…å›¾åƒæˆ–å ä½ç¬¦
                                    if i < root.thumbnails.length : Image {
                                        source: root.thumbnails[i];
                                        width: 48px;
                                        height: 48px;
                                        image-fit: contain;
                                    }

                                    // æ— å›¾åƒæ—¶æ˜¾ç¤ºå ä½ç¬¦
                                    if i >= root.thumbnails.length : Rectangle {
                                        width: 48px;
                                        height: 48px;
                                        background: #4ec9b0;
                                        border-radius: 2px;

                                        HorizontalLayout {
                                            alignment: center;

                                            Text {
                                                text: "ğŸ–¼ï¸";
                                                font-size: 20px;
                                            }
                                        }
                                    }

                                    // ç¼©ç•¥å›¾ç´¢å¼•
                                    Text {
                                        text: "#" + i;
                                        color: #cccccc;
                                        font-size: 11px;
                                        horizontal-alignment: center;
                                    }
                                }
                            }

                            // ç©ºçŠ¶æ€
                            if root.image_count == 0 : Rectangle {
                                width: 100%;
                                height: 100%;

                                Text {
                                    text: "æš‚æ— å›¾åƒ";
                                    color: #666;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                    font-size: 13px;
                                }
                            }
                        }
                    }
                }
            }

            // ========== åº•éƒ¨çŠ¶æ€æ  ==========
            Rectangle {
                background: #007acc;
                height: 22px;

                HorizontalLayout {
                    padding-left: 12px;
                    padding-right: 12px;
                    padding-top: 6px;
                    padding-bottom: 6px;

                    Text {
                        text: root.status_text;
                        color: #ffffff;
                        font-size: 11px;
                        vertical-alignment: center;
                    }

                    Rectangle {}

                    Text {
                        text: "Library Editor v1.0";
                        color: #ffffff;
                        font-size: 10px;
                        opacity: 0.7;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }
}
