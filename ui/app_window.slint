// Library Editor 主窗口
// 新布局：顶部菜单栏 + 中间左右分栏 + 底部缩略图
// 使用模块化组件

import { Toolbar } from "components/toolbar.slint";
import { PropertyPanel } from "components/property_panel.slint";
import { PreviewPanel } from "components/preview_panel.slint";
import { ThumbnailGrid } from "components/thumbnail_grid.slint";
import { StatusBar } from "components/status_bar.slint";
import { SettingsDialog } from "components/settings_dialog.slint";

export component AppWindow inherits Window {
    title: "Library Editor - Rust";
    min-width: 1024px;
    min-height: 768px;
    resize-border-width: 8px;

    // 将焦点转发给 FocusScope
    forward-focus: focus-scope;

    // 状态属性
    in-out property <string> status_text: "就绪";
    in-out property <string> file_name: "";
    in-out property <int> image_count: 0;
    in-out property <int> current_index: -1;

    // 图像信息
    in-out property <int> image_width: 0;
    in-out property <int> image_height: 0;
    in-out property <string> image_format: "-";
    in-out property <int> image_x: 0;
    in-out property <int> image_y: 0;

    // 缩略图数组（用于存储所有图像的缩略图数据）
    in-out property <[image]> thumbnails: [];

    // 主预览图（当前选中图像的大尺寸预览）
    in-out property <image> main_preview;

    // 主预览区背景色 (true=白色, false=黑色)
    in-out property <bool> preview_bg_light: false;

    // 缩放比例 (50-200, 默认100表示100%)
    in-out property <int> zoom_scale: 100;

    // 缩略图每行列数（用于键盘导航，由 thumbnail-grid 计算后传入）
    in-out property <int> thumb_cols: 1;

    // 加载进度 (0-100)
    in-out property <int> load_progress: 0;
    // 是否正在加载
    in-out property <bool> is_loading: false;
    // 已加载数量
    in-out property <int> loaded_count: 0;

    // 设置相关属性
    in-out property <bool> show_settings: false;
    in-out property <int> cache_max_size: 9999999;
    in-out property <int> key_throttle_ms: 50;

    // 回调
    callback open_file();
    callback save_file();
    callback save_as_file();
    callback export_png();
    callback replace_image();
    callback prev_image();
    callback next_image();
    callback thumbnail_clicked(int);
    callback toggle_preview_bg();
    callback key_pressed(string);
    // 请求加载指定范围的缩略图（懒加载）
    callback request_thumbnails(int, int);
    // 设置相关回调
    callback save_settings(int, int);

    // 主容器 - 使用 FocusScope 处理键盘事件
    focus-scope := FocusScope {
        width: 100%;
        height: 100%;

        key-pressed(event) => {
            // 如果设置对话框打开，Escape 关闭它
            if root.show_settings && event.text == Key.Escape {
                root.show_settings = false;
                return accept;
            }

            // 调用 Rust 回调处理所有按键逻辑（包括节流和导航）
            root.key_pressed(event.text);
            return accept;
        }

        Rectangle {
            background: #1e1e1e;

        VerticalLayout {
            spacing: 0px;

            // ========== 顶部菜单栏 ==========
            Toolbar {
                preview_bg_light: root.preview_bg_light;
                zoom_scale <=> root.zoom_scale;
                open_file => { root.open_file(); }
                save_file => { root.save_file(); }
                save_as_file => { root.save_as_file(); }
                export_png => { root.export_png(); }
                replace_image => { root.replace_image(); }
                prev_image => { root.prev_image(); }
                next_image => { root.next_image(); }
                toggle_preview_bg => { root.toggle_preview_bg(); }
                open_settings => { root.show_settings = true; }
            }

            // ========== 中间区域：左右分栏 ==========
            Rectangle {
                background: #1e1e1e;
                min-height: 400px;

                HorizontalLayout {
                    spacing: 0px;

                    // ========== 左侧：属性操作面板 ==========
                    PropertyPanel {
                        file_name: root.file_name;
                        image_count: root.image_count;
                        current_index: root.current_index;
                        image_x: root.image_x;
                        image_y: root.image_y;
                        image_width: root.image_width;
                        image_height: root.image_height;
                    }

                    // ========== 右侧：主预览区域 =========={


                     PreviewPanel {
                        current_index: root.current_index;
                        main_preview: root.main_preview;
                        preview_bg_light: root.preview_bg_light;
                        zoom_scale: root.zoom_scale;
                    }
                }
            }

            // ========== 底部：缩略图列表 ==========
            thumbnail-grid := ThumbnailGrid {
                image_count: root.image_count;
                current_index: root.current_index;
                thumbnails: root.thumbnails;
                cols_changed(cols) => { root.thumb_cols = cols; }
                thumbnail_clicked(index) => { root.thumbnail_clicked(index); }
                request_thumbnails(start, end) => { root.request_thumbnails(start, end); }
            }

            // ========== 底部状态栏 ==========
            StatusBar {
                status_text: root.status_text;
                load_progress: root.load_progress;
                is_loading: root.is_loading;
                loaded_count: root.loaded_count;
                image_count: root.image_count;
            }
        }
    }
    }

    // ========== 设置对话框（覆盖层） ==========
    if root.show_settings : SettingsDialog {
        cache_max_size <=> root.cache_max_size;
        key_throttle_ms <=> root.key_throttle_ms;
        save => {
            root.save_settings(root.cache_max_size, root.key_throttle_ms);
            root.show_settings = false;
        }
        cancel => {
            root.show_settings = false;
        }
    }
}
