// 底部缩略图网格组件
// 显示所有图像的缩略图，支持网格布局和滚动
// 支持懒加载：只在需要时请求加载可视范围的缩略图

import { ScrollView } from "std-widgets.slint";
import { FontSettings, Colors } from "../theme.slint";

export component ThumbnailGrid inherits Rectangle {
    // 属性
    in property <int> image_count: 0;
    in property <int> current_index: -1;
    in property <[image]> thumbnails: [];

    // 回调
    callback thumbnail_clicked(int);
    // 列数变化回调
    callback cols_changed(int);
    // 请求加载指定范围的缩略图（懒加载）
    callback request_thumbnails(int, int);

    // 内部计算列数 - 使用组件的实际宽度计算
    property <int> cols: max(1, floor((self.width - 16px) / 84px));

    background: Colors.bg-secondary;

    // 当宽度变化时通知父组件列数（比 changed cols 更可靠）
    changed width => {
        root.cols_changed(root.cols);
    }

    // 当图像数量变化时，重置请求范围
    changed image_count => {
        // 通过重置 scroll-y 来触发可视范围变化，从而请求加载
        // 或者直接在 Rust 端处理初始加载
    }

    VerticalLayout {
        spacing: 0px;

        // 缩略图标题栏
        Rectangle {
            background: Colors.bg-tertiary;
            height: 28px;

            HorizontalLayout {
                padding-left: 12px;
                padding-right: 12px;
                padding-top: 8px;
                padding-bottom: 8px;

                Text {
                    text: "缩略图";
                    color: Colors.text-primary;
                    font-family: FontSettings.chinese-font;
                    font-size: 12px;
                    font-weight: 600;
                    vertical-alignment: center;
                }

                Rectangle {}

                Text {
                    text: root.image_count + " 张图像";
                    color: Colors.text-secondary;
                    font-family: FontSettings.chinese-font;
                    font-size: 11px;
                    vertical-alignment: center;
                }
            }
        }

        // 缩略图滚动区域（网格布局）
        scroll-container := Rectangle {
            background: Colors.bg-primary;

            // 滚动位置（通过双向绑定控制 ScrollView）
            in-out property <length> scroll-y: 0px;

            // 虚拟滚动参数
            property <length> thumb-size: 84px;
            property <int> buffer-rows: 1;  // 上下缓冲行数
            property <int> total-rows: ceil(root.image_count / max(1, root.cols));
            property <length> content-height: self.total-rows * 84px + 8px;

            // 可视范围计算（基于滚动位置）
            property <int> first-visible-row: max(0, floor(-self.scroll-y / 84px) - self.buffer-rows);
            property <int> last-visible-row: min(self.total-rows - 1, ceil((-self.scroll-y + scroll-container.height) / 84px) + self.buffer-rows);

            // 可视范围的起始和结束索引
            property <int> visible-start: self.first-visible-row * max(1, root.cols);
            property <int> visible-end: min(root.image_count - 1, (self.last-visible-row + 1) * max(1, root.cols) - 1);

            // 上一次请求的范围（避免重复请求）
            property <int> last-request-start: -1;
            property <int> last-request-end: -1;

            // 接收父组件的 current_index
            property <int> sel_index: root.current_index;

            // 判断索引是否在可视范围内
            function is-visible(index: int) -> bool {
                if index < 0 || index >= root.image_count {
                    return false;
                }
                let row = floor(index / max(1, root.cols));
                return row >= self.first-visible-row && row <= self.last-visible-row;
            }

            // 当可视行变化时，请求加载缩略图
            changed first-visible-row => {
                if root.image_count > 0 && (self.visible-start != self.last-request-start || self.visible-end != self.last-request-end) {
                    self.last-request-start = self.visible-start;
                    self.last-request-end = self.visible-end;
                    root.request_thumbnails(self.visible-start, self.visible-end);
                }
            }

            changed last-visible-row => {
                if root.image_count > 0 && (self.visible-start != self.last-request-start || self.visible-end != self.last-request-end) {
                    self.last-request-start = self.visible-start;
                    self.last-request-end = self.visible-end;
                    root.request_thumbnails(self.visible-start, self.visible-end);
                }
            }

            // 当选中项变化时，确保缩略图可见
            changed sel_index => {
                let cols = max(1, root.cols);
                let current_row = self.sel_index >= 0 ? Math.floor(self.sel_index / cols) : 0;
                let thumb_top = 8px + current_row * 84px;
                let thumb_bottom = thumb_top + 80px;

                // viewport-y 是负值，需要取反
                let view_top = -scroll-container.scroll-y;
                let view_height = scroll-container.height;
                let view_bottom = view_top + view_height;

                let max_scroll = max(0px, scroll-container.content-height - view_height);

                // 如果缩略图在可视区域上方，向上滚动
                if thumb_top < view_top {
                    let new_y = max(0px, thumb_top - 4px);
                    scroll-container.scroll-y = -new_y;
                }
                // 如果缩略图在可视区域下方，向下滚动
                else if thumb_bottom > view_bottom {
                    let new_y = min(max_scroll, thumb_bottom - view_height + 4px);
                    scroll-container.scroll-y = -new_y;
                }
            }

            scroll-view := ScrollView {
                width: 100%;
                has-focus: true;
                height: 100%;
                viewport-width: scroll-container.width;
                viewport-height: scroll-container.content-height;
                viewport-y <=> scroll-container.scroll-y;

                Rectangle {
                    width: scroll-container.width;
                    height: scroll-container.content-height;

                    // 缩略图网格（使用绝对定位，只渲染可视范围内的）
                    for i in root.image_count : Rectangle {
                        // 只渲染可视范围内的缩略图
                        visible: scroll-container.is-visible(i);

                        x: 8px + Math.mod(i, root.cols) * 84px;
                        y: 8px + Math.floor(i / root.cols) * 84px;
                        width: 80px;
                        height: 80px;
                        background: i == root.current_index ? Colors.bg-selected : Colors.bg-tertiary;
                        border-width: i == root.current_index ? 2px : 1px;
                        border-color: i == root.current_index ? Colors.accent : Colors.border;
                        border-radius: 4px;

                        TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.thumbnail_clicked(i); }
                        }

                        // 缩略图预览
                        if i < root.thumbnails.length && root.thumbnails[i].width > 0 : Image {
                            source: root.thumbnails[i];
                            width: 72px;
                            height: 72px;
                            x: 4px;
                            y: 0px;
                            image-fit: contain;
                        }

                        // 无图像占位符（加载中或空）
                        if i >= root.thumbnails.length || root.thumbnails[i].width == 0 : Rectangle {
                            width: 72px;
                            height: 72px;
                            x: 4px;
                            y: 0px;
                            background: Colors.bg-hover;
                            border-radius: 4px;

                            Text {
                                text: "...";
                                color: Colors.text-disabled;
                                font-size: 12px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        // 索引标签
                        Rectangle {
                            visible: scroll-container.is-visible(i);
                            x: 4px;
                            y: 64px;
                            width: 28px;
                            height: 14px;
                            background: #00000080;
                            border-radius: 2px;

                            Text {
                                text: "#" + i;
                                color: Colors.text-white;
                                font-size: 9px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // 空状态
                    if root.image_count == 0 : Text {
                        text: "暂无图像";
                        color: Colors.text-disabled;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        font-family: FontSettings.chinese-font;
                        font-size: 13px;
                        x: (parent.width - self.width) / 2;
                        y: 40px;
                    }
                }
            }
        }
    }
}
