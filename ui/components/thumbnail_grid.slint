// 底部缩略图网格组件
// 显示所有图像的缩略图，支持网格布局和滚动

import { ScrollView } from "std-widgets.slint";
import { FontSettings, Colors } from "../theme.slint";

export component ThumbnailGrid inherits Rectangle {
    // 属性
    in property <int> image_count: 0;
    in property <int> current_index: -1;
    in property <[image]> thumbnails: [];

    // 回调
    callback thumbnail_clicked(int);
    // 列数变化回调
    callback cols_changed(int);

    // 内部计算列数 - 使用组件的实际宽度计算
    property <int> cols: max(1, floor((self.width - 16px) / 84px));

    background: Colors.bg-secondary;

    // 当宽度变化时通知父组件列数（比 changed cols 更可靠）
    changed width => {
        root.cols_changed(root.cols);
    }

    VerticalLayout {
        spacing: 0px;

        // 缩略图标题栏
        Rectangle {
            background: Colors.bg-tertiary;
            height: 28px;

            HorizontalLayout {
                padding-left: 12px;
                padding-right: 12px;
                padding-top: 8px;
                padding-bottom: 8px;

                Text {
                    text: "缩略图";
                    color: Colors.text-primary;
                    font-family: FontSettings.chinese-font;
                    font-size: 12px;
                    font-weight: 600;
                    vertical-alignment: center;
                }

                Rectangle {}

                Text {
                    text: root.image_count + " 张图像";
                    color: Colors.text-secondary;
                    font-family: FontSettings.chinese-font;
                    font-size: 11px;
                    vertical-alignment: center;
                }
            }
        }

        // 缩略图滚动区域（网格布局）
        scroll-container := Rectangle {
            background: Colors.bg-primary;

            // 使用 length 类型
            property <length> thumb-size: 84px;
            property <int> rows: ceil(root.image_count / max(1, root.cols));
            property <length> content-height: self.rows * 84px + 8px;

            // 滚动位置（通过双向绑定控制 ScrollView）
            in-out property <length> scroll-y: 0px;

            // 接收父组件的 current_index
            property <int> sel_index: root.current_index;

            // 当选中项变化时，确保缩略图可见
            changed sel_index => {
                let current_row = self.sel_index >= 0 ? Math.floor(self.sel_index / max(1, root.cols)) : 0;
                let thumb_top = 8px + current_row * 84px;
                let thumb_bottom = thumb_top + 80px;

                // viewport-y 是负值，需要取反
                let view_top = -scroll-container.scroll-y;
                let view_height = scroll-container.height;
                let view_bottom = view_top + view_height;

                let max_scroll = max(0px, scroll-container.content-height - view_height);

                // 如果缩略图在可视区域上方，向上滚动
                if thumb_top < view_top {
                    let new_y = max(0px, thumb_top - 4px);
                    scroll-container.scroll-y = -new_y;
                }
                // 如果缩略图在可视区域下方，向下滚动
                else if thumb_bottom > view_bottom {
                    let new_y = min(max_scroll, thumb_bottom - view_height + 4px);
                    scroll-container.scroll-y = -new_y;
                }
            }

            scroll-view := ScrollView {
                width: 100%;
                has-focus: true;
                height: 100%;
                viewport-width: scroll-container.width;
                viewport-height: scroll-container.content-height;
                viewport-y <=> scroll-container.scroll-y;

                Rectangle {
                    width: scroll-container.width;
                    height: scroll-container.content-height;

                    // 缩略图网格（使用绝对定位）
                    for i in root.image_count : Rectangle {
                        x: 8px + Math.mod(i, root.cols) * 84px;
                        y: 8px + Math.floor(i / root.cols) * 84px;
                        width: 80px;
                        height: 80px;
                        background: i == root.current_index ? Colors.bg-selected : Colors.bg-tertiary;
                        border-width: i == root.current_index ? 2px : 1px;
                        border-color: i == root.current_index ? Colors.accent : Colors.border;
                        border-radius: 4px;

                        TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.thumbnail_clicked(i); }
                        }

                        // 缩略图预览
                        if i < root.thumbnails.length && root.thumbnails[i].width > 0 : Image {
                            source: root.thumbnails[i];
                            width: 72px;
                            height: 72px;
                            x: 4px;
                            y: 0px;
                            image-fit: contain;
                        }

                        // 无图像占位符
                        if i >= root.thumbnails.length || root.thumbnails[i].width == 0 : Rectangle {
                            width: 72px;
                            height: 72px;
                            x: 4px;
                            y: 0px;
                            background: Colors.bg-hover;
                            border-radius: 4px;

                            Text {
                                text: "空";
                                color: Colors.text-disabled;
                                font-size: 12px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        // 索引标签
                        Rectangle {
                            x: 4px;
                            y: 64px;
                            width: 28px;
                            height: 14px;
                            background: #00000080;
                            border-radius: 2px;

                            Text {
                                text: "#" + i;
                                color: Colors.text-white;
                                font-size: 9px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // 空状态
                    if root.image_count == 0 : Text {
                        text: "暂无图像";
                        color: Colors.text-disabled;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        font-family: FontSettings.chinese-font;
                        font-size: 13px;
                        x: (parent.width - self.width) / 2;
                        y: 40px;
                    }
                }
            }
        }
    }
}
