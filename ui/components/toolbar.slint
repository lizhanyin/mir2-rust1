// 顶部工具栏组件
// 包含文件操作、导航等功能按钮

import { IconDisplay, IconSet } from "../lib/@lucide.slint";
import { FontSettings, Colors } from "../theme.slint";
import { IconButton } from "icon_button.slint";

export component Toolbar inherits Rectangle {
    // 回调
    callback open_file();
    callback save_file();
    callback save_as_file();
    callback export_png();
    callback replace_image();
    callback prev_image();
    callback next_image();
    callback toggle_preview_bg();
    callback open_settings();

    // 属性
    in property <bool> preview_bg_light: false;
    // 缩放比例 (50-200, 默认100)
    in-out property <int> zoom_scale: 100;

    background: Colors.bg-tertiary;
    height: 32px;

    HorizontalLayout {
        padding-left: 8px;
        padding-top: 4px;
        padding-right: 8px;
        spacing: 4px;

        // 文件操作按钮组
        IconButton {
            tooltip-text: "打开文件";
            clicked_handler => { root.open_file(); }
            IconDisplay {
                icon: IconSet.FolderOpen;
                size: 18px;
                stroke: Colors.text-primary;
            }
        }

        IconButton {
            tooltip-text: "保存文件";
            clicked_handler => { root.save_file(); }
            IconDisplay {
                icon: IconSet.Save;
                size: 18px;
                stroke: Colors.text-primary;
            }
        }

        IconButton {
            tooltip-text: "另存为";
            clicked_handler => { root.save_as_file(); }
            IconDisplay {
                icon: IconSet.FileOutput;
                size: 18px;
                stroke: Colors.text-primary;
            }
        }

        IconButton {
            tooltip-text: "导出PNG";
            clicked_handler => { root.export_png(); }
            IconDisplay {
                icon: IconSet.ImageDown;
                size: 18px;
                stroke: Colors.text-primary;
            }
        }

        IconButton {
            tooltip-text: "替换图像";
            clicked_handler => { root.replace_image(); }
            IconDisplay {
                icon: IconSet.RefreshCw;
                size: 18px;
                stroke: Colors.text-primary;
            }
        }

        // 分隔线
        Rectangle {
            width: 1px;
            background: Colors.border;
        }

        // 导航按钮组
        IconButton {
            tooltip-text: "上一张图像";
            clicked_handler => { root.prev_image(); }
            IconDisplay {
                icon: IconSet.ChevronLeft;
                size: 18px;
                stroke: Colors.text-primary;
            }
        }

        IconButton {
            tooltip-text: "下一张图像";
            clicked_handler => { root.next_image(); }
            IconDisplay {
                icon: IconSet.ChevronRight;
                size: 18px;
                stroke: Colors.text-primary;
            }
        }

        // 分隔线
        Rectangle {
            width: 1px;
            background: Colors.border;
        }

        // 缩放控制区域
        HorizontalLayout {
            spacing: 6px;
            alignment: center;

            // 缩小按钮
            IconButton {
                tooltip-text: "缩小";
                clicked_handler => {
                    if root.zoom_scale > 50 {
                        root.zoom_scale -= 10;
                    }
                }
                IconDisplay {
                    icon: IconSet.Minus;
                    size: 16px;
                    stroke: Colors.text-primary;
                }
            }

            // 缩放滑块
            Rectangle {
                width: 100px;
                height: 20px;
                border-radius: 4px;
                background: #2a2a2a;

                // 滑块轨道
                Rectangle {
                    x: 4px;
                    y: 8px;
                    width: parent.width - 8px;
                    height: 4px;
                    border-radius: 2px;
                    background: #404040;

                    // 已填充部分
                    Rectangle {
                        width: (parent.width * (root.zoom_scale - 50)) / 150;
                        height: 100%;
                        border-radius: 2px;
                        background: #4a9eff;
                    }
                }

                // 滑块手柄
                Rectangle {
                    x: 4px + (parent.width - 16px) * (root.zoom_scale - 50) / 150 - 6px;
                    y: 4px;
                    width: 12px;
                    height: 12px;
                    border-radius: 6px;
                    background: #ffffff;
                    border-width: 1px;
                    border-color: #4a9eff;
                }

                // 滑块交互区域
                TouchArea {
                    property <length> drag-start-x: 0;
                    property <int> drag-start-scale: 100;

                    pointer-event(event) => {
                        if event.button == PointerEventButton.left && event.kind == PointerEventKind.down {
                            self.drag-start-x = self.mouse-x;
                            self.drag-start-scale = root.zoom_scale;
                        }
                    }

                    moved => {
                        if self.pressed {
                            // 计算新位置并更新缩放值
                            let slider-width = 100px - 16px;
                            let delta-x = self.mouse-x - self.drag-start-x;
                            let new-value = self.drag-start-scale + (delta-x * 150 / slider-width);
                            root.zoom_scale = round(min(200, max(50, new-value)));
                        }
                    }
                }
            }

            // 放大按钮
            IconButton {
                tooltip-text: "放大";
                clicked_handler => {
                    if root.zoom_scale < 200 {
                        root.zoom_scale += 10;
                    }
                }
                IconDisplay {
                    icon: IconSet.Plus;
                    size: 16px;
                    stroke: Colors.text-primary;
                }
            }

            // 缩放百分比显示
            Text {
                text: root.zoom_scale + "%";
                color: Colors.text-primary;
                font-size: 12px;
                vertical-alignment: center;
                min-width: 40px;
            }
        }

        // 右侧弹性空间
        Rectangle {}

        // 设置按钮
        IconButton {
            tooltip-text: "设置";
            clicked_handler => { root.open_settings(); }
            IconDisplay {
                icon: IconSet.Settings;
                size: 18px;
                stroke: Colors.text-primary;
            }
        }

        // 切换背景色按钮
        IconButton {
            tooltip-text: root.preview_bg_light ? "切换到黑色背景" : "切换到白色背景";
            clicked_handler => { root.toggle_preview_bg(); }
            IconDisplay {
                icon: IconSet.Contrast;
                size: 18px;
                stroke: Colors.text-primary;
            }
        }
    }
}
